-- SERVICES
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Fungsi untuk menghitung waktu prediksi hingga tabrakan
local function timeUntilImpact(ballVelocity, distanceToPlayer, playerVelocity)
    local relativeVelocity = ballVelocity - playerVelocity
    return distanceToPlayer / relativeVelocity.Magnitude
end

-- Fungsi untuk mendapatkan threshold dinamis berdasarkan kecepatan bola
local function getDynamicThreshold(ballVelocityTowardsPlayer)
    return math.max(0.31, 0.5 - ballVelocityTowardsPlayer * 0.01)
end

-- Fungsi untuk menentukan apakah karakter sedang berjalan atau tidak
local function isWalkSpeedZero(character)
    return character and character:FindFirstChild("Humanoid") and character.Humanoid.WalkSpeed == 0
end

-- AutoParry logic
local function checkBallDistance(character, focusedBall)
    if not character or not character:FindFirstChild("Highlight") then return end

    local charPos = character.PrimaryPart.Position
    local charVel = character.PrimaryPart.Velocity

    if focusedBall and not focusedBall.Parent then
        print("Focused ball lost parent. Choosing a new focused ball.")
        chooseNewFocusedBall()
    end
    if not focusedBall then 
        print("No focused ball.")
        chooseNewFocusedBall()
    end

    local ball = focusedBall
    local distanceToPlayer = (ball.Position - charPos).Magnitude
    local ballVelocityTowardsPlayer = ball.Velocity:Dot((charPos - ball.Position).Unit)
    
    -- Kondisi Auto Parry saat bola mendekat
    if distanceToPlayer < 10 then
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game) -- Simulasi tombol parry
    end

    -- Cek waktu hingga benturan dan threshold untuk memparry
    if timeUntilImpact(ball.Velocity, distanceToPlayer, charVel) < getDynamicThreshold(ballVelocityTowardsPlayer) then
        if character.Abilities["Raging Deflection"].Enabled and UseRage == true then
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game) -- Simulasi kemampuan
            if not isWalkSpeedZero(character) then
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game) -- Simulasi tombol parry
            end
        else
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game) -- Simulasi tombol parry
        end
    end
end

-- Membuat GUI utama
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local AutoParryToggle = Instance.new("TextButton")
local Checkbox = Instance.new("TextButton")

-- Setup GUI
ScreenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.Position = UDim2.new(0.35, 0, 0.35, 0)
Frame.Size = UDim2.new(0, 300, 0, 200)
Frame.BorderSizePixel = 0

Title.Parent = Frame
Title.Text = "Vico Hub"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.TextSize = 20
Title.Size = UDim2.new(1, 0, 0, 50)
Title.BackgroundTransparency = 1
createGradient(Title)  -- Tambahkan gradient warna-warni pada title

-- Tombol untuk Toggle Auto Parry
AutoParryToggle.Parent = Frame
AutoParryToggle.Text = "Auto Parry!"
AutoParryToggle.Size = UDim2.new(0.8, 0, 0.2, 0)
AutoParryToggle.Position = UDim2.new(0.1, 0, 0.4, 0)
AutoParryToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
AutoParryToggle.TextColor3 = Color3.new(1, 1, 1)
AutoParryToggle.TextSize = 16

-- Checkbox untuk status AutoParry
Checkbox.Parent = Frame
Checkbox.Size = UDim2.new(0.2, 0, 0.2, 0)
Checkbox.Position = UDim2.new(0.7, 0, 0.4, 0)
Checkbox.BackgroundColor3 = Color3.fromRGB(255, 0, 0) -- Checkbox awal dalam kondisi tidak aktif

-- Variabel untuk AutoParry
local autoParryActive = false
local heartbeatConnection

-- Fungsi untuk mengaktifkan AutoParry
local function startAutoParry(character, focusedBall)
    if heartbeatConnection then return end
    heartbeatConnection = RunService.Heartbeat:Connect(function()
        checkBallDistance(character, focusedBall)
    end)
end

-- Fungsi untuk menghentikan AutoParry
local function stopAutoParry()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
        heartbeatConnection = nil
    end
end

-- Fungsi Toggle Auto Parry
AutoParryToggle.MouseButton1Click:Connect(function()
    autoParryActive = not autoParryActive
    Checkbox.BackgroundColor3 = autoParryActive and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0) -- Ganti warna checkbox
    print(autoParryActive and "Auto Parry Activated" or "Auto Parry Deactivated")
    animateGui(Frame, autoParryActive) -- Animasi fade ketika toggle

    if autoParryActive then
        local character = Players.LocalPlayer.Character
        local focusedBall = Workspace:FindFirstChild("Ball") -- Ganti dengan logika untuk memilih bola yang tepat
        startAutoParry(character, focusedBall)
    else
        stopAutoParry()
    end
end)

-- Animasi fade-in saat GUI muncul
animateGui(Frame, true)
